{%- if napalm_model.find('4331') > 0 and napalm_hostname.find('Glan-EU-GPN-MID-MPLS') > 0 -%}
no service pad
service timestamps debug datetime msec localtime show-timezone
service timestamps log datetime msec localtime show-timezone
service password-encryption
no platform punt-keepalive disable-kernel-core
!
hostname {{ MPLShostname }}
!
!
security passwords min-length 8
logging buffered 10000
enable secret 5 $1$5mp3$E6Kg9YOZpkTGnDMezTg971
!
clock timezone GMT 0 0
clock summer-time IST recurring last Sun Mar 2:00 last Sun Oct 2:00
no ip source-route
!

no ip bootp server
no ip domain lookup
ip domain name Glanbia
!
login block-for 100 attempts 5 within 100
!
!
subscriber templating
vtp mode transparent
!
no mpls ip propagate-ttl
!
!
multilink bundle-name authenticated
!
flow record NTA
 description Netflow record
 match ipv4 tos
 match ipv4 protocol
 match ipv4 source address
 match ipv4 destination address
 match transport source-port
 match transport destination-port
 collect interface input
 collect counter bytes long
 collect counter packets long
!
!
flow exporter Glanbia-Truview
 destination 10.106.110.10
 source Loopback0
 transport udp 2055
!
!
flow exporter BT-Truview
 destination 10.254.111.80
 source Loopback0
 transport udp 2055
!
!
flow monitor Netflow-Monitor
 exporter Glanbia-Truview
 exporter BT-Truview
 cache timeout active 1
 record netflow-original
!
!
!
!
crypto pki trustpoint TP-self-signed-3217455767
 enrollment selfsigned
 subject-name cn=IOS-Self-Signed-Certificate-3217455767
 revocation-check none
 rsakeypair TP-self-signed-3217455767
!
username Glaneng privilege 15 secret 5 $1$A.F8$8kEJfIWYEHLk9Y7yhI8Yc.
username Glandesk privilege 2 secret 5 $1$Sbz2$4jbMw5n1Dbw4Z8Gs1v6UF.
username Glanfield privilege 15 secret 5 $1$PmJK$vVDvklfXf1iY7ABkjBW86/
!
!
class-map match-any ce_ef_output
 match dscp ef
class-map match-any ce_af4_output
 match dscp af41  af42  af43
class-map match-any ce_af2_output
 match dscp af21  af22  af23
 match access-group name LANDESK
 match access-group name SAP
class-map match-any ce_af3_output
 match dscp af31  af32  af33
class-map match-any ce_af1_output
 match dscp af11  af12  af13
class-map match-any ce_mgmt
!
!
interface Loopback0
 ip address {{ MPLSLo0 }} 255.255.255.255
!
interface {{ WANInterface }}
 description ### {{ MPLSCircuit1 }} ###
 ip flow monitor Netflow-Monitor input
 ip flow monitor Netflow-Monitor output
 no ip address
 media-type rj45
 speed 100
 no negotiation auto
 no cdp enable
!
interface {{ WANInterface }}.{{ MPLSTAG }}
 description ### MPLS INTERFACE ###
 encapsulation dot1Q {{ MPLSTAG }}
 ip flow monitor Netflow-Monitor input
 ip flow monitor Netflow-Monitor output
 ip address {{ MPLSCEPeer }} {{ MPLSPeermask }}
 no cdp enable
!
interface {{ LANINT }}
 description ### LAN ###
 ip address {{ MPLSLANIP }}
 no ip redirects
 no ip unreachables
 no ip proxy-arp
 speed 1000
 no negotiation auto
!
interface GigabitEthernet0/0/2
 no ip address
 shutdown
 negotiation auto
!
interface GigabitEthernet0
 vrf forwarding Mgmt-intf
 no ip address
 shutdown
 negotiation auto
!
ip as-path access-list 1 permit ^$
!
ip access-list standard BLOCK-DMVPN-Loopback-OUT
 permit 10.254.11.116
 permit 10.254.11.113
ip access-list standard BT-MGMT-ACL
 permit 10.106.110.10
 permit 10.160.2.184
 permit 10.24.160.164
 permit 10.20.136.181
 permit 10.160.2.141
 permit 10.106.102.79
 permit 10.160.15.254
 permit 10.20.150.10
 permit 10.254.111.0 0.0.0.255
 deny   any log
ip access-list standard MPLS-ROUTES-INBOUND
 permit any
ip access-list standard NTP-ACL
 permit 10.254.1.80
 permit 10.254.1.92
ip access-list standard SSH-ACL
 remark ### VTY Access ###
 permit 10.0.0.0 0.255.255.255 log
 permit 192.168.0.0 0.0.255.255 log
 deny   any log
!
!
logging trap errors
logging source-interface Loopback0
logging host 10.254.111.10
!
!
route-map GLAN-MPLS-ROUTEMAP-IN permit 10
 match ip address MPLS-ROUTES-INBOUND
 set local-preference 250
!
route-map GLAN-MPLS-ROUTEMAP-OUT deny 10
 match ip address BLOCK-DMVPN-Loopback-OUT
!
route-map GLAN-MPLS-ROUTEMAP-OUT permit 20
 match as-path 1
!
route-map GLAN-MPLS-ROUTEMAP-OUT deny 30
!
router eigrp 100
 network {{ Vlan96 }}
 redistribute bgp {{ BGPAS }} metric 50000000 1 255 1 1500
 passive-interface default
 no passive-interface {{ LANINT }}
!
router bgp {{ BGPAS }}
 bgp log-neighbor-changes
 
 neighbor MPLSPEPeer remote-as {{ MPLSpeBGPAS }}
 neighbor MPLSPEPeer ebgp-multihop 4
 neighbor MPLSPEPeer update-source GigabitEthernet0/0/1.{{ MPLSTAG }}
 neighbor MPLSPEPeer route-map GLAN-MPLS-ROUTEMAP-IN in
 neighbor MPLSPEPeer route-map GLAN-MPLS-ROUTEMAP-OUT out
 neighbor {{ DMVPNiBGPPEER }} remote-as {{ BGPAS }}
 neighbor {{ DMVPNiBGPPEER }} description ### DMVPN Peer ###
 neighbor {{ DMVPNiBGPPEER }} next-hop-self
!
ip forward-protocol nd
ip ftp source-interface Loopback0

no ip http server
ip http authentication local
no ip http secure-server
ip tftp source-interface GigabitEthernet0
ip tacacs source-interface Loopback0
!
ip bgp-community new-format
ip ssh authentication-retries 5
ip ssh version 2
ip scp server enable
!

!
snmp-server group BTSNMP-RO v3 auth read full-mib write none access BT-MGMT-ACL
snmp-server group BTSNMP-RW v3 priv read full-mib write full-mib access BT-MGMT-ACL
snmp-server view none iso excluded
snmp-server view full-mib internet included
snmp-server view v1default iso excluded
snmp-server view inventory-mib internet included
snmp-server trap-source Loopback0
snmp-server location {{ SNMPLocation }}
snmp-server enable traps snmp authentication linkdown linkup coldstart warmstart
snmp-server enable traps cpu threshold
snmp-server enable traps bgp state-changes limited
snmp-server host 10.160.15.254 version 2c Glanbia
snmp-server host 10.254.111.11 version 2c Glanbia
snmp-server host 10.254.111.12 version 2c Glanbia
!
tftp-server bootflash:isr4300-universalk9.16.03.07.SPA.bin
tacacs-server host 10.254.111.49
tacacs-server directed-request
tacacs-server key 7 10680E4A113B155F1C1E2321
!
!
!
!
banner login _

_
!
banner motd &

  ~~~~ This is {{ MPLShostname }} ~~~~


Site                 : {{ site }}
Site code            : {{ sitecode }}
Device               : {{ MPLSDevice }}
Circuit ID           : {{ MPLSCircuit1 }}
Location             : {{ MPLSlocation }}

&
!
line con 0
 privilege level 15
 password 7 121B11040752550B383F
 stopbits 1
line aux 0
 exec-timeout 0 1
 privilege level 15
 no exec
 transport output none
 stopbits 1
line vty 0 4
 session-timeout 10
 access-class SSH-ACL in vrf-also
 privilege level 15
 transport input all
 transport output all
line vty 5 15
 privilege level 15
 transport input none
!
{%- else %}
{%- if napalm_model.find('2911') > 0 and napalm_hostname.find('Glan-EU-GPN-MID-DMVPN') > 0 -%}
!
banner login _
*************************
_
!
banner motd &

  ~~~~ This is {{ DMVPNhostname }} ~~~~


Site                 : {{ site }}
Site code            : {{ sitecode }}
Device               : {{ DMVPNDevice }}
Circuit ID           : {{ DMVPNCircuit1 }}
Location             : {{ DMVPNlocation }}

&

!
ip access-list standard SSH-ACL
 remark ### VTY Access ###
 permit 10.0.0.0 0.255.255.255 log
 permit 192.168.0.0 0.0.255.255 log
 permit 68.169.205.176 0.0.0.7 log
 permit 68.169.205.192 0.0.0.31 log
 permit 72.164.242.224 0.0.0.31 log
 permit 72.22.238.160 0.0.0.15 log
 permit 195.59.142.224 0.0.0.31 log
 permit 122.193.108.168 0.0.0.7 log
 permit 220.248.102.128 0.0.0.7 log
 permit 193.95.148.0 0.0.0.255 log
 permit 193.95.152.0 0.0.0.255 log
 permit 193.95.153.0 0.0.0.255 log
 permit 194.74.230.0 0.0.0.255 log
 deny any log
!
line con 0
  ! May not appear in configuration if default group used
  login authentication default
!
ip ssh version 2
!
line vty 0 4
  transport input ssh
  transport output none
  access-class SSH-ACL in vrf-also
  ! May not appear in configuration if default group used
  login authentication default
  session-timeout 10
 exec-timeout 10 0
!
line aux 0
 exec-timeout 0 1
 no exec
 transport output none
 stopbits 1
!
line vty 5 15
 transport input none
 transport output none
!
service password-encryption

!
login block-for 100 attempts 5 within 100
ip ssh authentication-retries 5
security passwords min-length 8
!
logging buffered 10000
logging trap errors
logging source-interface lo953
logging 10.254.111.10
!
service timestamps debug datetime msec localtime show-timezone
service timestamps log datetime msec localtime show-timezone
!
no ip domain lookup
no service tcp-small-servers
no service udp-small-servers
no service finger
vtp mode transparent
no ip http server
no ip http secure-server
no ip source-route
no ip bootp server
no service config
no boot network
no service pad
no service tcp-small-servers
no service udp-small-servers
no service finger
no ip rcmd rsh-enable
no ip rcmd rcp-enable
vtp mode transparent
ip scp server enable
no ipv6 Multicast-routing
!
interface {{ LANINT }}
 description ### {{ sitecode }} LAN ###
 no ip address
 no ip redirects
 no ip unreachables
 no ip proxy-arp
!
interface {{LANINT}}.96
 encapsulation dot1Q 96
 ip address {{ DMVPNLANIP }}
 no ip redirects
 no ip unreachables
 no ip proxy-arp
 ip nat inside
!

!
ip access-list standard BT-MGMT-ACL
 permit 10.106.110.10
 permit 10.160.2.184
 permit 10.24.160.164
 permit 10.20.136.181
 permit 10.160.2.141
 permit 10.106.102.79
 permit 10.160.15.254
 permit 10.20.150.10
 permit 10.254.111.0 0.0.0.255
 deny any log
!
!
snmp-server group BTSNMP-RO v3 auth read full-mib write none access BT-MGMT-ACL
snmp-server group BTSNMP-RW v3 priv read full-mib write full-mib access BT-MGMT-ACL

snmp-server user BTSNMP-USER BTSNMP-RW v3 auth sha c1sc0123 priv des c1sc0123
!
snmp-server view inventory-mib internet included
snmp-server view none iso excluded
snmp-server view full-mib internet included
snmp-server view v1default iso excluded

logging trap errors
!
snmp-server trap-source lo953
!
snmp-server host 10.160.15.254 version 2c Glanbia
snmp-server host 10.254.111.11 version 2c Glanbia
snmp-server host 10.254.111.12 version 2c Glanbia

!
clock timezone GMT 0 0
clock summer-time IST recurring last Sun Mar 2:00 last Sun Oct 2:00

ntp source lo953

ip access-list standard NTP-ACL
 permit 10.254.1.80
 permit 10.254.1.92
!
ntp access-group peer NTP-ACL
ntp server 10.254.1.80
ntp server 10.254.1.92
!
flow record NTA
 description Netflow record
 match ipv4 tos
 match ipv4 protocol
 match ipv4 source address
 match ipv4 destination address
 match transport source-port
 match transport destination-port
 collect interface input
 collect counter bytes long
 collect counter packets long
!
!
flow exporter Glanbia-Truview
 destination 10.106.110.10
 source Loopback953
 transport udp 2055

flow exporter BT-Truview
 destination 10.254.111.80
 source Loopback953
 transport udp 2055
!
!
flow monitor Netflow-Monitor
 exporter Glanbia-Truview
 exporter BT-Truview
 record netflow-original
 cache timeout active 1
!
interface {{ InternetInterface }}
 ip flow monitor Netflow-Monitor input
 ip flow monitor Netflow-Monitor output
!
crypto isakmp policy 2
encr aes 256
authentication pre-share
group 2
!
crypto isakmp policy 3
encr aes 256
authentication pre-share
group 5

!
crypto ipsec transform-set Glanbia-9999-DMVPN-5 esp-3des esp-sha256-hmac
 mode transport
!
crypto ipsec transform-set Glanbia-9999-DMVPN-2 esp-3des esp-md5-hmac
 mode tunnel
!
crypto ipsec profile vpnprof
 set transform-set Glanbia-9999-DMVPN-5 Glanbia-9999-DMVPN-2
!
interface Loopback953
description Glanbia DMVPN
ip add {{ Lo953 }} 255.255.255.255

ip as-path access-list 1 permit ^$
!
route-map GLAN-DMVPN-MGT-CLOUD-OUT permit 20
match as-path 1
!
route-map GLAN-DMVPN-MGT-CLOUD-OUT deny 30
!

route-map GLAN-DMVPN-ROUTEMAP-OUT permit 20
match as-path 1
set as-path prepend {{ BGPAS }} {{ BGPAS }} {{ BGPAS }}

route-map GLAN-DMVPN-ROUTEMAP-OUT deny 30
!
ip route 195.59.142.231 255.255.255.255 {{ InternetGateway }} name HPCitywest
ip route 68.169.205.180 255.255.255.255 {{ InternetGateway }} name Oakbrook
ip route 72.22.238.162 255.255.255.255 {{ InternetGateway }} name TFC-DMVPN

ip as-path access-list 251 permit ^64680$
ip as-path access-list 251 permit ^64680 64680 64680 64680$
ip as-path access-list 252 permit ^64759$
ip as-path access-list 252 permit ^64759 64759 64759 64759$
ip as-path access-list 253 permit ^64636$
ip as-path access-list 253 permit ^64636 64636 64636 64636$


route-map Default-PRIMARY permit 10
match as-path 252
set local-preference 80
!
route-map Default-PRIMARY permit 20
match as-path 253
set local-preference 60
!
route-map Default-PRIMARY permit 20
match as-path 251
set local-preference 40

!
router bgp {{ BGPAS }}
 bgp log-neighbor-changes

 neighbor dmvpn-peers peer-group
 neighbor dmvpn-peers next-hop-self
 neighbor dmvpn-peers route-map Default-PRIMARY in
 neighbor dmvpn-peers route-map GLAN-DMVPN-ROUTEMAP-OUT out
 neighbor 10.109.132.251 remote-as 64680
 neighbor 10.109.132.251 peer-group dmvpn-peers
 neighbor 10.109.132.251 description Citywest-MFA-Citadel
 neighbor 10.109.132.252 remote-as 64759
 neighbor 10.109.132.252 peer-group dmvpn-peers
 neighbor 10.109.132.252 description MFH-Oakbrook
 neighbor 10.109.132.253 remote-as 64636
 neighbor 10.109.132.253 peer-group dmvpn-peers
 neighbor 10.109.132.253 description TFC-Twinfalls
!
object-group network Remote-Public-A
 host 195.59.142.231
 host 194.74.230.34
 host 72.22.238.162
 host 68.169.205.180
 !
 object-group network Local-Networks
 10.25.32.0 255.255.224.0
 173.241.113.32 255.255.255.248

object-group network WebsenseCloud
 86.111.216.0 255.255.254.0
 86.111.220.0 255.255.252.0
 103.1.196.0 255.255.252.0
 116.50.56.0 255.255.248.0
 177.39.96.0 255.255.252.0
 85.115.32.0 255.255.224.0
 196.216.238.0 255.255.254.0
 208.87.232.0 255.255.248.0
 85.115.52.0 255.255.252.0
!
ip access-list extended INBOUND
 permit ip object-group Remote-Public-A any
 permit icmp any any
 permit udp any any eq bootps bootpc
 permit ip object-group Remote-Public-A object-group Local-Networks
 permit ip object-group WebsenseCloud object-group Local-Networks
!
ip access-list extended OUTBOUND
 permit icmp any any echo
 permit ip any object-group Remote-Public-A
 permit icmp object-group Local-Networks any echo
 permit tcp object-group Local-Networks object-group WebsenseCloud eq www
 permit tcp object-group Local-Networks object-group WebsenseCloud eq 443
 permit icmp object-group Local-Networks object-group WebsenseCloud echo
 permit tcp object-group Local-Networks any eq www
 permit tcp object-group Local-Networks any eq smtp
 permit tcp object-group Local-Networks any eq 443
 permit udp object-group Local-Networks any eq domain
 permit icmp object-group Local-Networks any
 permit ip object-group Local-Networks object-group Remote-Public-A
!
 interface {{ InternetInterface }}
 ip access-group INBOUND in
 ip access-group OUTBOUND out
!
ip sla 124
 icmp-echo 62.40.32.33 source-interface {{ InternetInterface }}
 tag Websense IPSLA to New DNS
ip sla schedule 124 life forever start-time now
ip sla 125
 icmp-echo 8.8.8.8 source-interface {{ InternetInterface }}
 tag Websense IPSLA to Google DNS
ip sla schedule 125 life forever start-time now

track 123 list boolean or
 object 124
 object 125
!
track 124 ip sla 124 reachability
!
track 125 ip sla 125 reachability
!
ip route 85.115.32.0 255.255.224.0 {{ InternetGateway }} tag 250 name WebsenseCloud track 123
ip route 86.111.216.0 255.255.254.0 {{ InternetGateway }} tag 250 name WebsenseCloud track 123
ip route 86.111.220.0 255.255.252.0 {{ InternetGateway }} tag 250 name WebsenseCloud track 123
ip route 103.1.196.0 255.255.252.0 {{ InternetGateway }} tag 250 name WebsenseCloud track 123
ip route 116.50.56.0 255.255.248.0 {{ InternetGateway }} tag 250 name WebsenseCloud track 123
ip route 177.39.96.0 255.255.252.0 {{ InternetGateway }} tag 250 name WebsenseCloud track 123
ip route 196.216.238.0 255.255.254.0 {{ InternetGateway }} tag 250 name WebsenseCloud track 123
ip route 208.87.232.0 255.255.248.0 {{ InternetGateway }} tag 250 name WebsenseCloud track 123
!
interface Tunnel132
 ip address {{ T132 }} 255.255.255.0
 no ip redirects
 ip mtu 1400
 ip nhrp authentication glanbia
 ip nhrp network-id 132
 ip nhrp holdtime 300
 ip nhrp nhs 10.109.132.251 nbma 195.59.142.231 multicast
 ip nhrp nhs 10.109.132.252 nbma 68.169.205.180 multicast
 ip nhrp nhs 10.109.132.253 nbma 72.22.238.162 multicast
 ip nhrp registration timeout 15
 ip nhrp redirect
 ip tcp adjust-mss 1360
 tunnel source {{ InternetInterface }}
 tunnel mode gre multipoint
 tunnel key 123
 tunnel protection ipsec profile vpnprof shared
 crypto ipsec df-bit clear
 no shut
!
ip access-list extended Corp-NAT-outbound
 permit ip object-group Local-Networks object-group WebsenseCloud

ip nat inside source list Corp-NAT-outbound interface {{ InternetInterface }} overload
!
ip vrf GBS-Guest
 description GBS Guest Vlan
!
ip dhcp pool GBS-Guest
 vrf GBS-Guest
 network 172.16.200.0 255.255.255.0
 default-router 172.16.200.1
 dns-server 8.8.8.8 8.8.4.4
 class GBS-Guest
  address range 172.16.200.100 172.16.200.254
!
!
ip dhcp class GBS-Guest
!
vlan 664
vlan 999
!
interface {{ LANINT }}.664
 description ### GBS-Guest ###
 encapsulation dot1q 664
 ip vrf forwarding GBS-Guest
 ip address 172.16.200.1 255.255.255.0
 no ip redirects
 no ip unreachables
 no ip proxy-arp
 ip nat inside
 no shutdown
!
ip nat inside source list GBS-Guest-NAT-Outbound interface {{ InternetInterface }} vrf GBS-Guest overload
!
ip route vrf GBS-Guest 0.0.0.0 0.0.0.0 {{ InternetInterface }} {{ InternetGateway }} name GBS-Guest
!
route-map STATICtoEIGRP permit 10
 match tag 250
!
router eigrp 100
 network {{ Vlan96 }}
 redistribute bgp {{ BGPAS }} metric 5000000 1 255 1 1500
 redistribute static metric 1000 1 255 1 1500 route-map STATICtoEIGRP
 passive-interface default
 no passive-interface {{ LANSUBINT }}

{%- endif %}
{%- endif %}
